<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ReClaim ‚Äî AI Research Validation</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: #0f1117; color: #e2e8f0; min-height: 100vh; display: flex; flex-direction: column; }
    main { flex: 1; padding: 2rem; max-width: 860px; margin: 0 auto; width: 100%; }

    /* ‚îÄ‚îÄ Logo & Header ‚îÄ‚îÄ */
    .logo-bar { display: flex; align-items: center; gap: 0.85rem; margin-bottom: 0.4rem; }
    .logo-mark {
      width: 42px; height: 42px; border-radius: 10px;
      background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.3rem; font-weight: 900; color: #fff; letter-spacing: -1px;
      box-shadow: 0 0 18px rgba(99,102,241,0.4);
      flex-shrink: 0;
    }
    .logo-text h1 { font-size: 1.7rem; font-weight: 800; color: #fff; line-height: 1; }
    .logo-text .tagline { font-size: 0.78rem; color: #4b5563; margin-top: 0.2rem; letter-spacing: 0.05em; text-transform: uppercase; }

    .header { margin-bottom: 1.75rem; padding-bottom: 1.25rem; border-bottom: 1px solid #1e2a3a; }
    .header-desc { font-size: 0.88rem; color: #64748b; margin-top: 0.75rem; line-height: 1.6; max-width: 600px; }
    .header-desc strong { color: #94a3b8; }

    /* ‚îÄ‚îÄ Upload ‚îÄ‚îÄ */
    .upload-zone {
      border: 2px dashed #334155; border-radius: 12px; padding: 1.75rem;
      text-align: center; cursor: pointer; transition: all 0.2s;
      background: #1e2230; margin-bottom: 1rem;
    }
    .upload-zone:hover, .upload-zone.dragover { border-color: #3b82f6; background: #1a2740; }
    .upload-zone.has-file { border-color: #22c55e; background: #0f2318; }
    .upload-zone input { display: none; }
    .upload-icon { font-size: 2rem; margin-bottom: 0.4rem; }
    .upload-label { font-size: 0.9rem; color: #94a3b8; }
    .file-name { color: #22c55e; font-weight: 600; margin-top: 0.4rem; font-size: 0.9rem; }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn-row { display: flex; gap: 0.6rem; margin-bottom: 1.25rem; }
    .btn-primary {
      flex: 1; padding: 0.85rem; border: none; border-radius: 8px;
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      color: #fff; font-size: 0.95rem; font-weight: 700;
      cursor: pointer; transition: opacity 0.2s;
    }
    .btn-primary:hover:not(:disabled) { opacity: 0.88; }
    .btn-primary:disabled { background: #1e2a3a; color: #4b5563; cursor: not-allowed; }
    .btn-reset {
      padding: 0.85rem 1.1rem; border-radius: 8px; border: 1px solid #334155;
      background: #1e2230; color: #64748b; font-size: 0.9rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s; white-space: nowrap;
    }
    .btn-reset:hover { border-color: #4b5563; color: #94a3b8; background: #252d3d; }

    .error-box { background: #2d1515; border: 1px solid #7f1d1d; color: #fca5a5; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem; font-size: 0.875rem; display: none; }
    .error-box.visible { display: block; }

    /* ‚îÄ‚îÄ Status ‚îÄ‚îÄ */
    .status-bar { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; font-size: 0.85rem; color: #64748b; }
    .pulse { width: 8px; height: 8px; border-radius: 50%; background: #3b82f6; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .pulse.done { background: #22c55e; animation: none; }
    .pulse.error { background: #f87171; animation: none; }

    /* ‚îÄ‚îÄ Output ‚îÄ‚îÄ */
    .output-container { background: #0d1117; border: 1px solid #21262d; border-radius: 10px; overflow: hidden; display: none; }
    .output-container.visible { display: block; }

    .tabs { display: flex; border-bottom: 1px solid #21262d; background: #161b22; overflow-x: auto; }
    .tab-btn {
      flex: 1; min-width: 90px; padding: 0.75rem 0.5rem; font-size: 0.78rem; font-weight: 600;
      color: #64748b; background: none; border: none; cursor: pointer;
      border-bottom: 2px solid transparent; transition: all 0.15s; white-space: nowrap;
    }
    .tab-btn:hover { color: #94a3b8; background: #1a2030; }
    .tab-btn.active { color: #60a5fa; border-bottom-color: #3b82f6; background: #0d1117; }

    .tab-content { display: none; padding: 1.25rem; min-height: 420px; max-height: 520px; overflow-y: auto; }
    .tab-content.active { display: block; }

    /* Console */
    .console { font-family: 'Courier New', monospace; font-size: 0.78rem; }
    .console-header { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #21262d; }
    .dot { width: 11px; height: 11px; border-radius: 50%; }
    .dot-r{background:#ff5f56}.dot-y{background:#ffbd2e}.dot-g{background:#27c93f}
    .console-title { color: #4b5563; font-size: 0.75rem; margin-left: 0.25rem; }
    .line { margin-bottom: 2px; white-space: pre-wrap; word-break: break-word; }
    .line.tool{color:#60a5fa}.line.warn{color:#fbbf24}.line.error{color:#f87171}
    .line.done{color:#4ade80;font-weight:bold}.line.plain{color:#cbd5e1}

    /* Micro-questions */
    .mq-item { background: #0f1724; border: 1px solid #1e2a3a; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; }
    .mq-num { font-size: 0.7rem; color: #3b82f6; font-weight: 700; text-transform: uppercase; margin-bottom: 0.35rem; }
    .mq-q { font-size: 0.88rem; font-weight: 600; color: #e2e8f0; margin-bottom: 0.5rem; }
    .mq-a { font-size: 0.82rem; color: #94a3b8; line-height: 1.6; }
    .mq-badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700; margin-top: 0.5rem; }
    .badge-verified{background:#052e16;color:#4ade80}
    .badge-partial{background:#1c1a00;color:#fbbf24}
    .badge-unverifiable{background:#1a0a00;color:#fb923c}
    .badge-contradicted{background:#2d0a0a;color:#f87171}

    /* Synthesis */
    .synthesis-block { margin-bottom: 1.25rem; }
    .synthesis-block h3 { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.08em; color: #3b82f6; margin-bottom: 0.5rem; }
    .synthesis-block p { font-size: 0.85rem; color: #94a3b8; line-height: 1.7; }

    /* Coherence */
    .score-hero { text-align: center; padding: 1.5rem; margin-bottom: 1.25rem; background: #0f1724; border-radius: 10px; border: 1px solid #1e3a5f; }
    .score-num { font-size: 3.5rem; font-weight: 800; line-height: 1; }
    .score-label { font-size: 0.8rem; color: #64748b; margin-top: 0.25rem; }
    .score-high{color:#4ade80}.score-mid{color:#fbbf24}.score-low{color:#f87171}
    .coh-item { margin-bottom: 1rem; }
    .coh-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem; }
    .coh-aspect { font-size: 0.83rem; color: #e2e8f0; font-weight: 600; }
    .coh-score { font-size: 0.83rem; font-weight: 700; }
    .progress { background: #1e2a3a; border-radius: 4px; height: 6px; }
    .progress-bar { height: 6px; border-radius: 4px; transition: width 0.6s ease; }
    .bar-high{background:#22c55e}.bar-mid{background:#f59e0b}.bar-low{background:#ef4444}
    .coh-reason { font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; }

    /* README tab */
    .readme { font-size: 0.85rem; line-height: 1.75; color: #94a3b8; }
    .readme h2 { font-size: 1.1rem; font-weight: 700; color: #e2e8f0; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid #1e2a3a; }
    .rm-section { margin-bottom: 1.5rem; }
    .rm-section h3 { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.08em; color: #3b82f6; margin-bottom: 0.6rem; }
    .rm-section p { margin-bottom: 0.5rem; }
    .rm-section em { color: #e2e8f0; font-style: italic; }
    .rm-section code { background: #1a2030; padding: 0.1rem 0.35rem; border-radius: 3px; font-family: monospace; font-size: 0.8rem; color: #60a5fa; }
    .rm-code { background: #0a0e17; border: 1px solid #1e2a3a; border-radius: 6px; padding: 0.75rem 1rem; font-family: monospace; font-size: 0.78rem; color: #60a5fa; white-space: pre; overflow-x: auto; margin-bottom: 0.75rem; }
    .rm-steps { display: flex; flex-direction: column; gap: 0.6rem; }
    .rm-step { display: flex; align-items: flex-start; gap: 0.75rem; }
    .step-num { background: #1e3a5f; color: #60a5fa; font-size: 0.72rem; font-weight: 700; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 0.1rem; }
    .rm-badges { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; margin: 0.5rem 0; font-size: 0.8rem; }
    .rm-list { padding-left: 1.25rem; margin: 0.5rem 0; }
    .rm-list li { margin-bottom: 0.25rem; }

    /* Download bar */
    .download-bar { display: flex; gap: 0.75rem; padding: 0.85rem 1.25rem; border-top: 1px solid #21262d; background: #0a0e17; flex-wrap: wrap; }
    .dl-btn { padding: 0.45rem 0.9rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 1px solid #1e3a5f; background: #0f1724; color: #60a5fa; transition: all 0.15s; }
    .dl-btn:hover { background: #1e2a40; border-color: #3b82f6; }

    .placeholder { color: #2d3748; font-size: 0.85rem; text-align: center; padding: 3rem 1rem; }

    /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
    footer {
      border-top: 1px solid #1a2030; padding: 1.25rem 2rem;
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 0.75rem;
      background: #0a0e17;
    }
    .footer-left { display: flex; align-items: center; gap: 0.6rem; }
    .footer-logo { font-size: 0.9rem; font-weight: 800; color: #3b82f6; letter-spacing: -0.5px; }
    .footer-sep { color: #1e2a3a; }
    .footer-copy { font-size: 0.78rem; color: #374151; }
    .footer-right { display: flex; align-items: center; gap: 1rem; }
    .footer-link { font-size: 0.78rem; color: #374151; text-decoration: none; transition: color 0.15s; display: flex; align-items: center; gap: 0.3rem; }
    .footer-link:hover { color: #60a5fa; }
    .footer-author { font-size: 0.78rem; color: #374151; }
  </style>
</head>
<body>
<main>

  <!-- Header -->
  <div class="header">
    <div class="logo-bar">
      <div class="logo-mark">RC</div>
      <div class="logo-text">
        <h1>ReClaim</h1>
        <div class="tagline">Check. Mate. ‚Äî AI Research Validation</div>
      </div>
    </div>
    <p class="header-desc">
      Upload any research paper and ReClaim will independently verify its claims using
      <strong>live scientific tools</strong> ‚Äî PubMed, ArXiv, Semantic Scholar and 900+ more.
      Honest about what AI can and cannot verify.
    </p>
  </div>

  <!-- Upload -->
  <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
    <input type="file" id="fileInput" accept=".pdf" />
    <div class="upload-icon">üìÑ</div>
    <p class="upload-label">Drop research PDF here or click to browse</p>
    <p class="file-name" id="fileName"></p>
  </div>

  <div class="error-box" id="errorBox"></div>

  <div class="btn-row">
    <button class="btn-primary" id="analyzeBtn" disabled onclick="startAnalysis()">Upload a PDF to begin</button>
    <button class="btn-reset" title="Reset" onclick="resetAll()">‚Ü∫ Reset</button>
  </div>

  <div class="status-bar" id="statusBar" style="display:none">
    <div class="pulse" id="pulseIndicator"></div>
    <span id="statusText">Running ToolUniverse validation...</span>
  </div>

  <!-- Output -->
  <div class="output-container" id="outputContainer">
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('console')">‚öôÔ∏è Console</button>
      <button class="tab-btn" onclick="switchTab('microq')">‚ùì Micro-Questions</button>
      <button class="tab-btn" onclick="switchTab('synthesis')">üìù Synthesis</button>
      <button class="tab-btn" onclick="switchTab('coherence')">üìä Coherence</button>
      <button class="tab-btn" onclick="switchTab('readme')">üìñ README</button>
    </div>

    <!-- Console -->
    <div class="tab-content active console" id="tab-console">
      <div class="console-header">
        <div class="dot dot-r"></div><div class="dot dot-y"></div><div class="dot dot-g"></div>
        <span class="console-title">gemini CLI ‚Äî ToolUniverse live output</span>
      </div>
      <div id="consoleOutput"></div>
    </div>

    <!-- Micro-Questions -->
    <div class="tab-content" id="tab-microq">
      <div id="mqOutput"><p class="placeholder">Run analysis to see micro-questions and answers.</p></div>
    </div>

    <!-- Synthesis -->
    <div class="tab-content" id="tab-synthesis">
      <div id="synthOutput"><p class="placeholder">Run analysis to see output synthesis.</p></div>
    </div>

    <!-- Coherence -->
    <div class="tab-content" id="tab-coherence">
      <div id="cohOutput"><p class="placeholder">Run analysis to see coherence scores.</p></div>
    </div>

    <!-- README -->
    <div class="tab-content" id="tab-readme">
      <div class="readme">
        <h2>ReClaim ‚Äî Research Validation Tool</h2>
        <div class="rm-section">
          <h3>üìã What Is ReClaim?</h3>
          <p>ReClaim takes any research paper and independently verifies its claims using live scientific tools ‚Äî not just language model knowledge. It tells you what AI can confirm, what it cannot, and why.</p>
        </div>
        <div class="rm-section">
          <h3>‚öôÔ∏è How It Works</h3>
          <div class="rm-steps">
            <div class="rm-step"><span class="step-num">1</span><div><strong>Upload</strong> ‚Äî Drop any research PDF.</div></div>
            <div class="rm-step"><span class="step-num">2</span><div><strong>Extract</strong> ‚Äî Top claims and findings are identified.</div></div>
            <div class="rm-step"><span class="step-num">3</span><div><strong>Micro-Questions</strong> ‚Äî One targeted validation question per claim.</div></div>
            <div class="rm-step"><span class="step-num">4</span><div><strong>Tool Verification</strong> ‚Äî ToolUniverse searches PubMed, ArXiv, Semantic Scholar and 900+ sources independently.</div></div>
            <div class="rm-step"><span class="step-num">5</span><div><strong>Coherence Score</strong> ‚Äî Internal consistency, methodology, and citation quality scored 0‚Äì100.</div></div>
            <div class="rm-step"><span class="step-num">6</span><div><strong>Hallucination Flags</strong> ‚Äî Zones AI cannot verify are explicitly flagged.</div></div>
          </div>
        </div>
        <div class="rm-section">
          <h3>üèóÔ∏è Architecture</h3>
          <div class="rm-code">Frontend ‚Üí Flask ‚Üí Gemini CLI ‚Üí ToolUniverse MCP (900+ tools)
Output streams live via Server-Sent Events (SSE)</div>
        </div>
        <div class="rm-section">
          <h3>üîÅ Swappable Backends</h3>
          <p>ToolUniverse is the default validation engine, but ReClaim is designed to be backend-agnostic. Future support planned for Perplexity, Tavily, and You.com.</p>
        </div>
        <div class="rm-section">
          <h3>‚ö†Ô∏è Known Limitations</h3>
          <p>ReClaim verifies literature-backed claims. It cannot verify claims that require proprietary datasets, custom simulations, or computational experiments. It surfaces this gap honestly rather than hiding it.</p>
        </div>
        <div class="rm-section">
          <h3>üîç Verification Statuses</h3>
          <div class="rm-badges">
            <span class="mq-badge badge-verified">verified</span>
            <span class="mq-badge badge-partial">partially-verified</span>
            <span class="mq-badge badge-unverifiable">unverifiable</span>
            <span class="mq-badge badge-contradicted">contradicted</span>
          </div>
        </div>
        <div class="rm-section">
          <h3>üõ†Ô∏è Setup</h3>
          <div class="rm-code">pip3 install flask flask-cors PyPDF2 python-dotenv
cp .env.example .env   # add your API key + paths
python3 app.py
# Open http://127.0.0.1:5001/</div>
          <p>See the <a href="https://github.com/arjunshrivatsan/reclaim" style="color:#60a5fa">GitHub repo</a> for full setup instructions.</p>
        </div>
      </div>
    </div>

    <!-- Downloads -->
    <div class="download-bar" id="downloadBar" style="display:none">
      <button class="dl-btn" onclick="downloadFile('microq')">‚¨á Micro-Questions.txt</button>
      <button class="dl-btn" onclick="downloadFile('synthesis')">‚¨á Synthesis.txt</button>
      <button class="dl-btn" onclick="downloadFile('coherence')">‚¨á Coherence.txt</button>
      <button class="dl-btn" onclick="downloadFile('console')">‚¨á Console Log.txt</button>
      <button class="dl-btn" onclick="downloadFile('all')">‚¨á Full Report.txt</button>
    </div>
  </div>

</main>

<!-- Footer -->
<footer>
  <div class="footer-left">
    <span class="footer-logo">ReClaim</span>
    <span class="footer-sep">¬∑</span>
    <span class="footer-copy">MIT License ¬∑ Open Source</span>
  </div>
  <div class="footer-right">
    <span class="footer-author">Built by Arjun Shrivatsan</span>
    <a class="footer-link" href="https://linkedin.com/in/arjunshrivatsan" target="_blank">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
      LinkedIn
    </a>
    <a class="footer-link" href="mailto:gurumurthy.ar@northeastern.edu">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
      Contact
    </a>
  </div>
</footer>

<script>
const BACKEND = "http://localhost:5001";
let selectedFile = null;
let rawData = { console: "", microq: [], synthesis: {}, coherence: {} };

const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
fileInput.addEventListener("change", e => setFile(e.target.files[0]));
dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("dragover"); });
dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
dropZone.addEventListener("drop", e => { e.preventDefault(); dropZone.classList.remove("dragover"); setFile(e.dataTransfer.files[0]); });

function setFile(file) {
  if (!file || file.type !== "application/pdf") { showError("Please upload a PDF file."); return; }
  selectedFile = file;
  document.getElementById("fileName").textContent = file.name;
  dropZone.classList.add("has-file");
  const btn = document.getElementById("analyzeBtn");
  btn.disabled = false;
  btn.textContent = "‚úÖ Validate with ReClaim";
  hideError();
}

function resetAll() { window.location.reload(); }

function switchTab(name) {
  const names = ["console","microq","synthesis","coherence","readme"];
  document.querySelectorAll(".tab-btn").forEach((b,i) => b.classList.toggle("active", names[i] === name));
  document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
  document.getElementById("tab-" + name).classList.add("active");
}

async function startAnalysis() {
  if (!selectedFile) return;
  const btn = document.getElementById("analyzeBtn");
  btn.disabled = true;
  btn.textContent = "Running...";
  hideError();
  rawData = { console: "", microq: [], synthesis: {}, coherence: {} };

  document.getElementById("outputContainer").classList.add("visible");
  document.getElementById("consoleOutput").innerHTML = "";
  document.getElementById("mqOutput").innerHTML = "<p class='placeholder'>Waiting for results...</p>";
  document.getElementById("synthOutput").innerHTML = "<p class='placeholder'>Waiting for results...</p>";
  document.getElementById("cohOutput").innerHTML = "<p class='placeholder'>Waiting for results...</p>";
  document.getElementById("downloadBar").style.display = "none";
  switchTab("console");

  const statusBar = document.getElementById("statusBar");
  const pulse = document.getElementById("pulseIndicator");
  const statusText = document.getElementById("statusText");
  statusBar.style.display = "flex";
  pulse.className = "pulse";
  statusText.textContent = "Running ToolUniverse validation...";

  appendConsole("$ gemini --yolo -p [reclaim validation prompt]", "tool");
  appendConsole("", "plain");

  const formData = new FormData();
  formData.append("file", selectedFile);

  try {
    const response = await fetch(`${BACKEND}/analyze`, { method: "POST", body: formData });
    if (!response.ok) { const e = await response.json(); throw new Error(e.error || "Backend error"); }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "", fullText = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split("\n");
      buffer = lines.pop();
      for (const line of lines) {
        if (line.startsWith("data: ")) {
          const content = line.slice(6).trim();
          if (content === "[DONE]") {
            appendConsole("\n‚úÖ Validation complete.", "done");
            pulse.className = "pulse done";
            statusText.textContent = "Validation complete.";
            btn.disabled = false;
            btn.textContent = "üîÑ Re-Validate";
            parseAndRender(fullText);
            document.getElementById("downloadBar").style.display = "flex";
            return;
          }
          if (content) { fullText += content + "\n"; appendConsole(content, classifyLine(content)); }
        }
      }
    }
  } catch (err) {
    showError("Connection failed: " + err.message);
    pulse.className = "pulse error";
    statusText.textContent = "Error.";
    btn.disabled = false;
    btn.textContent = "‚úÖ Validate with ReClaim";
  }
}

function classifyLine(t) {
  if (/tool|calling|fetching|searching|mcp|api|pubmed|arxiv|semantic/i.test(t)) return "tool";
  if (/warning|warn/i.test(t)) return "warn";
  if (/error|failed|exception/i.test(t)) return "error";
  return "plain";
}

function appendConsole(text, cls) {
  rawData.console += text + "\n";
  const out = document.getElementById("consoleOutput");
  const div = document.createElement("div");
  div.className = `line ${cls}`;
  div.textContent = text;
  out.appendChild(div);
  out.scrollTop = out.scrollHeight;
}

function parseAndRender(text) {
  const jsonMatch = text.match(/```json\s*([\s\S]*?)```/) || text.match(/(\{[\s\S]*"coherenceScores"[\s\S]*\})/);
  if (jsonMatch) {
    try { renderStructured(JSON.parse(jsonMatch[1].trim())); return; } catch(e) {}
  }
  renderRaw(text);
}

function renderStructured(data) {
  const mqEl = document.getElementById("mqOutput");
  if (data.microQuestions?.length) {
    rawData.microq = data.microQuestions;
    mqEl.innerHTML = data.microQuestions.map((q,i) => `
      <div class="mq-item">
        <div class="mq-num">Question ${i+1} ¬∑ Claim #${q.targetClaim||""} ¬∑ <span style="color:#94a3b8">${q.difficulty||""} difficulty</span></div>
        <div class="mq-q">Q: ${q.question}</div>
        <div class="mq-a">A: ${q.answer||q.verification||"See console for details."}</div>
        <span class="mq-badge ${badgeClass(q.status)}">${q.status||"verified"}</span>
      </div>`).join("");
  } else { mqEl.innerHTML = "<p class='placeholder'>No structured micro-questions found. See console.</p>"; }

  rawData.synthesis = data;
  document.getElementById("synthOutput").innerHTML = `
    <div class="synthesis-block"><h3>Paper</h3><p>${data.title||""} ¬∑ ${data.domain||""}</p></div>
    <div class="synthesis-block"><h3>Summary</h3><p>${data.summary||""}</p></div>
    <div class="synthesis-block"><h3>Key Claims</h3>${(data.claims||[]).map(c=>`<p style="margin-bottom:0.5rem">‚Ä¢ <strong>${c.type}:</strong> ${c.text} <span style="font-size:0.75rem;color:${c.verifiable?"#4ade80":"#f87171"}">[${c.verifiable?"AI Verifiable":"Requires Computation"}]</span></p>`).join("")}</div>
    <div class="synthesis-block"><h3>Unverifiable Zones</h3>${(data.hallucinationFlags||[]).map(f=>`<p style="margin-bottom:0.5rem">‚Ä¢ <strong style="color:${riskColor(f.risk)}">[${f.risk}]</strong> ${f.zone} ‚Äî ${f.reason}</p>`).join("")}</div>`;

  const overall = data.overallCoherence||0;
  document.getElementById("cohOutput").innerHTML = `
    <div class="score-hero">
      <div class="score-num ${overall>=75?"score-high":overall>=50?"score-mid":"score-low"}">${overall}</div>
      <div class="score-label">Overall Coherence Score / 100</div>
    </div>
    ${(data.coherenceScores||[]).map(c=>`
      <div class="coh-item">
        <div class="coh-row"><span class="coh-aspect">${c.aspect}</span><span class="coh-score ${c.score>=75?"score-high":c.score>=50?"score-mid":"score-low"}">${c.score}/100</span></div>
        <div class="progress"><div class="progress-bar ${c.score>=75?"bar-high":c.score>=50?"bar-mid":"bar-low"}" style="width:${c.score}%"></div></div>
        <div class="coh-reason">${c.reasoning}</div>
      </div>`).join("")}`;
}

function renderRaw(text) {
  const mqMatch = text.match(/###.*[Mm]icro[\s\S]*?(?=###|$)/);
  const synthMatch = text.match(/###.*(?:[Ss]ynthes|[Ss]ummary)[\s\S]*?(?=###|$)/);
  const cohMatch = text.match(/###.*[Cc]oherence[\s\S]*?(?=###|$)/);
  document.getElementById("mqOutput").innerHTML = `<div style="font-size:0.85rem;color:#94a3b8;line-height:1.8;white-space:pre-wrap">${mqMatch?mqMatch[0]:text}</div>`;
  document.getElementById("synthOutput").innerHTML = synthMatch ? `<div style="font-size:0.85rem;color:#94a3b8;line-height:1.8;white-space:pre-wrap">${synthMatch[0]}</div>` : "<p class='placeholder'>See console for full output.</p>";
  document.getElementById("cohOutput").innerHTML = cohMatch ? `<div style="font-size:0.85rem;color:#94a3b8;line-height:1.8;white-space:pre-wrap">${cohMatch[0]}</div>` : "<p class='placeholder'>See console for full output.</p>";
}

function badgeClass(s) {
  if (!s) return "badge-verified";
  if (s.includes("partial")) return "badge-partial";
  if (s.includes("unverif")) return "badge-unverifiable";
  if (s.includes("contradict")) return "badge-contradicted";
  return "badge-verified";
}
function riskColor(r) { return r==="high"?"#f87171":r==="medium"?"#fbbf24":"#4ade80"; }

function downloadFile(type) {
  const paper = selectedFile?.name?.replace(".pdf","") || "paper";
  const ts = new Date().toISOString().slice(0,10);
  let content = "", filename = "";
  if (type==="console") { content=rawData.console; filename=`${paper}_console_${ts}.txt`; }
  else if (type==="microq") { content=rawData.microq.map((q,i)=>`Q${i+1}: ${q.question}\nA: ${q.answer||q.verification||""}\nStatus: ${q.status||""}`).join("\n\n---\n\n"); filename=`${paper}_micro_questions_${ts}.txt`; }
  else if (type==="synthesis") { const d=rawData.synthesis; content=`RESEARCH SYNTHESIS\n${"=".repeat(50)}\nTitle: ${d.title||""}\nDomain: ${d.domain||""}\n\nSummary:\n${d.summary||""}\n\nClaims:\n${(d.claims||[]).map(c=>`- [${c.type}] ${c.text}`).join("\n")}\n\nUnverifiable Zones:\n${(d.hallucinationFlags||[]).map(f=>`- [${f.risk}] ${f.zone}: ${f.reason}`).join("\n")}`; filename=`${paper}_synthesis_${ts}.txt`; }
  else if (type==="coherence") { const d=rawData.synthesis; content=`COHERENCE REPORT\n${"=".repeat(50)}\nOverall: ${d.overallCoherence||""}/100\n\n${(d.coherenceScores||[]).map(c=>`${c.aspect}: ${c.score}/100\n${c.reasoning}`).join("\n\n")}`; filename=`${paper}_coherence_${ts}.txt`; }
  else if (type==="all") { content=`RECLAIM ‚Äî FULL VALIDATION REPORT\nAuthor: Arjun Shrivatsan\nPaper: ${selectedFile?.name}\nDate: ${ts}\n\n${"=".repeat(60)}\n\nCONSOLE:\n${rawData.console}\n\n${"=".repeat(60)}\n\nMICRO-QUESTIONS:\n${rawData.microq.map((q,i)=>`Q${i+1}: ${q.question}\nA: ${q.answer||""}\nStatus: ${q.status||""}`).join("\n\n")}\n\n${"=".repeat(60)}\n\nSYNTHESIS:\n${rawData.synthesis.summary||""}\n\n${"=".repeat(60)}\n\nCOHERENCE: ${rawData.synthesis.overallCoherence||""}/100`; filename=`${paper}_FULL_REPORT_${ts}.txt`; }
  const blob = new Blob([content], {type:"text/plain"});
  const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
}

function showError(msg) { const b=document.getElementById("errorBox"); b.textContent=msg; b.classList.add("visible"); }
function hideError() { document.getElementById("errorBox").classList.remove("visible"); }
</script>
</body>
</html>